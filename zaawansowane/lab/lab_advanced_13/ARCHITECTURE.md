# Architektura Lab Advanced 13

## Diagram ASCII

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Azure Subscription                              â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Resource Group: rg-logicapp-dev                             â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Virtual Network: vnet-logicapp-dev                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Address Space: 10.30.0.0/16                         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ subnet-logic: 10.30.1.0/24               â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Delegation: Microsoft.Web/serverFarms    â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                           â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚ Logic App Standard          â”‚         â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚ â”œâ”€ App Service Plan (WS1)   â”‚         â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚ â”œâ”€ Managed Identity         â”‚         â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚ â””â”€ VNet Integration â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ subnet-pe: 10.30.2.0/24                  â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Private Endpoints                        â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                           â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚  PE: blob   â”‚  â”‚  PE: file   â”‚      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚  10.30.2.4  â”‚  â”‚  10.30.2.5  â”‚      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚          â”‚                â”‚              â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚  PE: queue  â”‚  â”‚  PE: table  â”‚      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â”‚  10.30.2.6  â”‚  â”‚  10.30.2.7  â”‚      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ subnet-other: 10.30.3.0/24               â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (reserved for future resources)          â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Storage Account: stlogicdev123                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Public Access: Disabled                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ TLS: 1.2 minimum                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Network Rules: Deny (default)                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”‚ Private Link Service                  â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”‚ â”œâ”€ blob.core.windows.net              â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”‚ â”œâ”€ file.core.windows.net              â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”‚ â”œâ”€ queue.core.windows.net             â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â”‚ â””â”€ table.core.windows.net             â”‚        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Private DNS Zones                                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ privatelink.blob.core.windows.net               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ privatelink.file.core.windows.net               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ privatelink.queue.core.windows.net              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ privatelink.table.core.windows.net              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  [All linked to VNet for DNS resolution]            â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## PrzepÅ‚yw komunikacji

### 1. Logic App â†’ Storage (przez Private Endpoint)
```
Logic App (subnet-logic)
    â”‚
    â”œâ”€ VNet Integration
    â”‚
    â”œâ”€ DNS Resolution: stlogicdev123.blob.core.windows.net
    â”‚   â””â”€> Private DNS Zone: privatelink.blob.core.windows.net
    â”‚       â””â”€> A record: 10.30.2.4
    â”‚
    â””â”€> Private Endpoint (subnet-pe: 10.30.2.4)
        â””â”€> Storage Account (private link service)
            â””â”€> Blob Container

âš¡ Ruch przez Azure Backbone (nie Internet)
ğŸ”’ Szyfrowanie: TLS 1.2+
```

### 2. External Client â†’ Logic App (public endpoint)
```
Internet
    â”‚
    â”œâ”€> Azure Load Balancer
    â”‚
    â””â”€> Logic App Standard
        â”œâ”€ Public HTTPS endpoint: logic-workflow-dev.azurewebsites.net
        â””â”€ Internal communication through VNet Integration
```

### 3. Managed Identity â†’ Storage (autoryzacja)
```
Logic App Managed Identity (Principal ID)
    â”‚
    â”œâ”€ Azure AD Authentication
    â”‚
    â””â”€> Storage Account RBAC
        â””â”€ Role: Storage Blob Data Contributor
            â””â”€ Access Granted
```

## Komponenty sieciowe

### VNet Integration
- **Typ**: Regional VNet Integration
- **Subnet**: subnet-logic (delegacja wymagana)
- **Routing**: Route all traffic through VNet (`vnet_route_all_enabled=true`)

### Private Endpoints
| ZasÃ³b | Subresource | Private IP | DNS Zone |
|-------|-------------|------------|----------|
| Storage | blob | 10.30.2.4 | privatelink.blob.core.windows.net |
| Storage | file | 10.30.2.5 | privatelink.file.core.windows.net |
| Storage | queue | 10.30.2.6 | privatelink.queue.core.windows.net |
| Storage | table | 10.30.2.7 | privatelink.table.core.windows.net |

### Private DNS Resolution
```
Application requests: stlogicdev123.blob.core.windows.net
    â”‚
    â”œâ”€ Azure DNS checks Private DNS Zone: privatelink.blob.core.windows.net
    â”‚   â””â”€ Found: A record â†’ 10.30.2.4
    â”‚
    â””â”€> Resolved to Private IP (not public)
```

## BezpieczeÅ„stwo

### Network Isolation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Public Internet          â”‚
â”‚  â”œâ”€ âŒ Storage Public IP â”‚  <-- Blocked (public_network_access=false)
â”‚  â””â”€ âœ… Logic App HTTPS   â”‚  <-- Allowed (public endpoint)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Azure Backbone (Private) â”‚
â”‚  â””â”€ âœ… All communication  â”‚  <-- Through Private Endpoints
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Identity & Access
```
Logic App (System Assigned Managed Identity)
    â”‚
    â”œâ”€ No secrets in code
    â”œâ”€ No access keys exposed
    â”‚
    â””â”€> Azure AD RBAC
        â””â”€ Granular permissions per resource
```

## Koszty (breakdown)

```
Component                    | SKU/Type | Cost/month (USD) | Notes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
App Service Plan             | WS1      | ~$200            | Can be stopped
Storage Account              | LRS      | ~$2-5            | + transactions
Private Endpoint (blob)      | Standard | ~$7              |
Private Endpoint (file)      | Standard | ~$7              |
Private Endpoint (queue)     | Standard | ~$7              |
Private Endpoint (table)     | Standard | ~$7              |
Private DNS Zone (x4)        | Standard | ~$0.50 each      |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL                                   | ~$240/month      | Stop when unused
```

ğŸ’¡ **Cost optimization for dev**:
- Stop App Service Plan outside working hours: `az appservice plan update --name asp-logicapp-dev --sku FREE` (not for production!)
- Use lifecycle policies for Storage blobs
- Delete environment completely when not in use

## Next Steps
- Add NSG rules for subnet-logic
- Configure Application Insights
- Deploy sample workflow
- Add second Logic App for inter-app communication
